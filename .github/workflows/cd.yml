name: CD

on:
  push:
    branches:
      - staging  # Runs when staging is updated

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GH CLI
        run: echo "${{ secrets.REPO_TOKEN }}" | gh auth login --with-token

      - name: Create or update PR from staging → main
        run: |
          # Check if PR already exists
          PR_URL=$(gh pr list --head staging --base main --json url -q '.[0].url')
          if [ -z "$PR_URL" ]; then
            echo "Creating new PR..."
            gh pr create --title "Auto-merge staging → main [skip ci]" \
                         --body "Auto-generated PR from CI/CD workflow." \
                         --head staging --base main
          else
            echo "PR already exists: $PR_URL"
          fi

      - name: Auto-merge PR
        run: |
          PR_URL=$(gh pr list --head staging --base main --json url,state -q '.[0].url')
          if [ ! -z "$PR_URL" ]; then
            echo "Merging PR..."
            gh pr merge $PR_URL --merge --auto 
          else
            echo "No PR to merge"
          fi

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
        shell: bash

      - name: Deploy to Droplet
        run: |
          echo "User: '${{ secrets.DO_SSH_USER }}'"
          echo "Host: '${{ secrets.DO_SSH_HOST }}'"
          ssh -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DP_SSH_HOST }} \
          "cd ~/app/4-final-cash-me-if-you-can/scripts && ./deploy.sh"
        shell: bash
